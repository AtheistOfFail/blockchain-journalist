$(document).ready(function(){
	new Clipboard('.clipboard_object', {
    text: function(trigger) {
        return handleGeneration();
    }
	});

	var fields = null;
	var titles = null;
	var article = null;

	var active_targets = [];
	$.getJSON(chrome.extension.getURL('/configs/data.json'), function(data) {
		fields = data["fields"];
		titles = data["titles"];
		article = data["article"];
		
		$("#buttons").html();
		$.each(fields, function(index, value){
			for (target in value) {
				var raw_target = target
				var target = target.replace(" ", "_");
				$("#buttons").append('<a id="'+target+'" type="button" data-target="input_'+target+'" class="btn btn-flat">'+target+'</a>')
				$("#inputs").append("<div style='display:none' class='text-center' id='"+raw_target+"'><input id='input_"+target+"' type='text' placeholder='"+value[raw_target]+"'></input><a id='remove_"+target+"' data-target='"+target+"' type='button' class='btn btn-flat' style='width:50%'>Remove "+target+"</a></div>");
				$("#remove_"+target).click(handleInputRemoval);
				$("#"+target).click(handleButtonClick);
			}
		});
	});

	function handleButtonClick(evt){
		$(this).hide();
		$("#"+$(this).data("target")).parent().show();
		$("#"+$(this).data("target")).parent().addClass("field_active");
		updateUI();
	}

	function handleInputRemoval(evt){
		$(this).parent().removeClass("field_active");
		$(this).parent().hide();
		$("#"+$(this).data("target")).show();
		updateUI();
	}

	function handleGeneration(){
		var target = "BIG TEXT GOES HERE";

		var IDs = [];
		$(".field_active").each(function(){ IDs.push(this.id); });

		
		//Write the generation code here.
		return target;
	}

	function updateUI(){
		var IDs = [];
		$(".field_active").each(function(){ IDs.push(this.id); });

		if (verifySufficient(IDs)){
			$("#output").show();
		}
		else {
			$("#output").hide();
		}
	}

	function verifySufficient(currentIDs){
		var reqs = false;
		for (var i = 0; i < titles.length; i++) {
   		if (contains(currentIDs, titles[i]["reqs"])){
   			reqs = true;
   		}
		}

		if (!reqs){
			return reqs;
		}

		for (var i = 0; i < article.length; i++) {
   		if (contains(currentIDs, article[i]["reqs"])){
   			reqs = true;
   		}
		}

		return reqs;
	}

	function contains(haystack, needle){
  	for(var i = 0; i < needle.length; i++){
    	if(haystack.indexOf(needle[i]) === -1)
      	 return false;
  	}
  	return true;
	}
});